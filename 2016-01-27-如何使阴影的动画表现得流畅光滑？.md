åŸæ–‡åœ°å€ï¼š[http://tobiasahlin.com/blog/how-to-animate-box-shadow/](http://tobiasahlin.com/blog/how-to-animate-box-shadow/)

* * * 

ä½ å¦‚ä½•é¿å…é‡ç»˜è€Œåˆèƒ½ä¿è¯ `box-shadow` çš„åŠ¨ç”»ï¼Œå¹¶ä¸”ä¸å½±å“åˆ°ä½ é¡µé¢çš„æ•ˆæœå‘¢ï¼Ÿå®é™…ä¸Šï¼šä½ ä¸èƒ½ã€‚box-shadow çš„åŠ¨ç”»ååˆ†å½±å“æµç•…æ€§ã€‚

How do you animate the `box-shadow` property in CSS without causing re-paints on every frame, and heavily impacting the performance of your page? Short answer: you don't. Animating a change of box-shadow will hurt performance.

ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåŠç®€å•åˆä¼˜é›…çš„èƒ½è¾¾åˆ°ç±»ä¼¼æ•ˆæœçš„æ–¹æ³•ï¼Œä»¥æœ€å°‘çš„é‡ç»˜ï¼Œæ¥ä¿è¯ä½ çš„åŠ¨ç”»ä»¥ 60 FPS çš„å¸§ç‡è¿è¡Œï¼šé‚£å°±æ˜¯ï¼Œæ”¹å˜ä¼ªå…ƒç´ çš„ `opacity`ï¼Œä»¥å®ç° `box-shadow` çš„åŠ¨ç”»æ•ˆæœã€‚

There's an easy way of mimicking the same effect, however, with minimal re-paints, that should let your animations run at a solid 60 FPS: animate the `opacity` of a pseudo-element.

## æ¼”ç¤ºï¼ˆDemoï¼‰

![å®é™…ä¸Šçš„æ•ˆæœçš„å½•åƒï¼ˆRecording of box-shadow demo in actionï¼‰](//c.hime.io/images/QOBw.gif)

[ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æ¼”ç¤º](http://tobiasahlin.com/demo/animate-box-shadow/)å¹¶ä¸”å¯¹æ¯”ä¸€ä¸‹æˆ‘ä»¬æ‰€è¦è®²çš„ä¸¤ç§ä¸åŒçš„æ–¹æ³•çš„åŒºåˆ«ã€‚å¦‚æœä½ çœ‹èµ·æ¥è§‰å¾—è¿™ä¸¤ä¸ªåŠ¨ç”»ä¸€æ ·ï¼Œé‚£å°±å¯¹äº†ã€‚å› ä¸ºå”¯ä¸€çš„ä¸åŒæ˜¯ï¼Œæˆ‘ä»¬å¦‚ä½•å®ç°é˜´å½±çš„åŠ¨ç”»ã€‚å·¦è¾¹çš„é‚£éƒ¨åˆ†ï¼Œæˆ‘ä»¬è®© `box-shadow` åœ¨ `hover` åè¢«èµ‹å€¼ï¼Œè€Œå³è¾¹çš„é‚£éƒ¨åˆ†ï¼Œåˆ™æ˜¯ä½¿ç”¨äº†ä¼ªå…ƒç´  `::after`ï¼Œè®©é˜´å½±é™„åŠ åœ¨ä¼ªå…ƒç´ ä¸Šï¼Œå¹¶ä¸”é€šè¿‡ `opacity` çš„å˜åŒ–æ¥å®ç°ä¸å·¦è¾¹ç›¸åŒã€ç”šè‡³æ›´æµç•…çš„æ•ˆæœã€‚

[Have a look at the demo](http://tobiasahlin.com/demo/animate-box-shadow/) and compare the two different techniques we'll be exploring. If the two examples look the same to you, that's the point. The only difference is how we apply and animate the shadow. On the left we're animating `box-shadow` on `hover`, and on the right we're adding a pseudo-element with ::after, applying the shadow to that, and animating the `opacity` of that element.

å¦‚æœä½ æ‰“å¼€ä½ çš„å¼€å‘è€…å·¥å…·ï¼Œæ¥ç€å°†é¼ æ ‡ç½®æ‚¬åœ¨è¿™äº›å…ƒç´ ä¸Šï¼Œä½ ä¼šå‘ç°ç±»ä¼¼è¿™ä¸ªä¸‹å›¾çš„æƒ…å†µï¼ˆè¢«ä¸Šè‰²çš„ç»¿è‰²éƒ¨åˆ†æ˜¯é‡ç»˜æ‰€ç”¨çš„æ—¶é•¿ï¼›è¶ŠçŸ­è¶Šå¥½ï¼‰ï¼š

If you bring up your developer tools and hover one of these items, you should see something similar to this (green bars are paints; less is better):

![ä¸¤ç§ä¸åŒåŠ¨ç”»çš„å®ç°æ•ˆç‡ï¼ˆAnimation performance when hovering the different boxesï¼‰](https://c.hime.io/images/j0l4.png)

é€šè¿‡å®ƒï¼Œæˆ‘ä»¬èƒ½å¾ˆæ˜ç¡®çš„çŸ¥é“ï¼Œå½“æˆ‘ä»¬åˆ’è¿‡å·¦è¾¹é‚£äº›å¡ç‰‡æ—¶ï¼ˆæ”¹å˜ `box-shadow`ï¼‰ï¼Œå°†ä»–ä¸å³ä¾§çš„åˆ’è¿‡å¡ç‰‡ç›¸æ¯”ï¼ˆæ”¹å˜ä¼ªå…ƒç´ çš„ `opacity`ï¼‰ã€‚

There are clearly more re-paints when hovering the cards on the left side (animating `box-shadow`), compared to hovering the cards on the right side (which animate the `opacity` of their pseudo-element).

ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šæ”¶è·åˆ°è¿™ç§æ•ˆæœï¼Ÿå› ä¸ºè¿™é‡Œçš„[å°‘è®¸ CSS å±æ€§](http://csstriggers.com/)åŠ¨ç”»æ—¶æ˜¯å¯ä»¥ä¸éœ€ä¸€ç›´è§¦å‘æ¯å¸§çš„é‡ç»˜ï¼Œå°±å¦‚ `opacity` ä¸ `transform`ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜å®ƒä¿©ï¼Œä»è€Œè¾¾åˆ°å‡å°‘é‡ç»˜çš„æ•°é‡ï¼ˆå’Œæµè§ˆå™¨æ‰€éœ€è¦å»åšçš„ï¼‰çš„ç›®çš„ã€‚

Why are we seeing this effect? There are [very few CSS properties](http://csstriggers.com/) that can be animated without constantly triggering repaints for every frame, namely `opacity` and `transform`. We minimize the amount of repaints (and work that your browser has to do) by sticking to only changing these two properties during the animation.

è¿™é‡Œæ˜¯ä¸¤ç§æ–¹æ³•çš„**å…·ä½“çš„åŒºåˆ«**ï¼ŒæŠ›å¼€å¸ƒå±€ä¸Šæ¥è®²ï¼š

This is the **ritical difference** between the two techniques, stripping out all of the other layout styles:


```
/* æ…¢çš„é‚£ç§æ–¹æ³• */
/* The slow way */
.make-it-slow {
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  transition: box-shadow 0.3s ease-in-out:
}

/* åˆ’è¿‡åä»æ— åˆ°æœ‰çš„é˜´å½± */
/* Transition to a bigger shadow on hover */
.make-it-slow:hover {
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* å¿«çš„é‚£ç§æ–¹æ³• */
/* The fast way */
.make-it-fast {
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

/* æå‰æ¸²æŸ“å¥½é˜´å½±ï¼Œä¸è¿‡éšè—ç€çš„ */
/* Pre-render the bigger shadow, but hide it */
.make-it-fast::after {
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  opacity: 0;
  transition: opacity 0.3s ease-in-out:
}

/* åˆ’è¿‡åé˜´å½±æ˜¾éœ²å‡ºæ¥ */
/* Transition to showing the bigger shadow on hover */
.make-it-fast:hover::after {
  opacity: 1;
}
```

ä»ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ›´æœ‰æ•ˆç‡çš„é‚£ä¸€ç§æ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤å±‚ï¼šä¸€å±‚ç»™å¡ç‰‡ï¼Œå¦å¤–ä¸€å±‚æ˜¯é˜´å½±çš„ï¼Œå¹¶ä¸”ï¼ŒåŠ¨ç”»åªæ”¹å˜é˜´å½±çš„ `opacity`ã€‚

In the example that performs better we have two layers: one for the box, and one for the shadow, and only animate the opacity property of the shadow layer.

## åˆ†è§£ï¼ˆBreaking it downï¼‰

æœ‰äº†åŸºæœ¬åŸç†ï¼Œé‚£å°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºçš„[3D æ•ˆæœå¡ç‰‡](http://tobiasahlin.com/demo/animate-box-shadow/)ã€‚ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯éœ€è¦ç»™ä¼ªå…ƒç´ æ·»åŠ é˜´å½±ï¼Œå°±åƒæˆ‘ç›Ÿåœ¨ä¸Šé¢åšçš„ä¸€æ ·ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¥å†™å‡ºæ‰€æœ‰çš„ä»£ç ï¼ŒåŒ…æ‹¬å¸ƒå±€ï¼š

With the fundamentals in place, let's look at how to create [the 3D card effect showcased in the demo](http://tobiasahlin.com/demo/animate-box-shadow/). The first step is to move the shadow to a pseudo-element, like we did above. Let's also add all of the layout code to create the card:

```
/* HTML ä¸­ä½ åªéœ€è¦ <div class="box"></div> */
/* All HTML you need is <div class="box"></div> */

/* åˆ›å»ºä¸€ä¸ªç™½è‰²çš„å¡ç‰‡ï¼Œç„¶åç»™å®ƒæ·»åŠ é»˜è®¤çš„é˜´å½±çŠ¶æ€ */
/* Create a simple white box, and add the shadow for the initial state */
.box {
  position: relative;
  display: inline-block;
  width: 100px;
  height: 100px;
  border-radius: 5px;
  background-color: #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  transition: all 0.3s ease-in-out;
}

/* åˆ›å»ºéšè—çš„ä¼ªå…ƒç´  */
/* åŒ…æ‹¬é˜´å½±çš„æœ€åçŠ¶æ€ */
/* Create the hidden pseudo-element */
/* include the shadow for the end state */
.box::after {
  content: '';
  position: absolute;
  z-index: -1;
  width: 100%;
  height: 100%;
  opacity: 0;
  border-radius: 5px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  transition: opacity 0.3s ease-in-out;
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ç»™ `.box` å’Œ `.box::after` æ·»åŠ äº†ä¸€ä¸ª `transition`ï¼Œå¹¶ä¸”å½“è¿™äº›å…ƒç´ å¼€å§‹æ’­æ”¾åŠ¨ç”»çš„æ—¶å€™ï¼Œè¿™äº›å±æ€§ä¼šå‘ç”Ÿæ”¹å˜ï¼š`.box` çš„ `transform` å’Œ `.box::after` çš„ `opacity`ã€‚

Note that we're adding a `transition` to both the `.box`, and `.box::after`, since we're going to animate both of these elements: `transform` for `.box`, and `opacity` for `.box::after`.

è¿™ä¸‰ä¸ªæ ·å¼ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¥‡å¦™çš„ `box-shadow`ã€‚æ›´å¼ºå¤§çš„æ˜¯ï¼Œ`.box::after` åœ¨é»˜è®¤æ—¶æ˜¯å®Œå…¨éšè—çš„ï¼ŒåŒæ—¶å®ƒå¹¶ä¸ä¼šä¸å¡ç‰‡ç›¸äº’ä½œç”¨ã€‚

These styles give us a white box with a subtle `box-shadow`. The stronger shadow from `.box::after` is completely hidden at this point, and you can't interact with the box:

<div id="box-1"></div>
<style type="text/css">
#box-1 { position: relative; display: block; margin: 0 auto; width: 100px; height: 100px; border-radius: 5px; background-color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.3s ease-in-out; }
#box-1::after { content: ''; position: absolute; z-index: -1; width: 100%; height: 100%; opacity: 0; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: opacity 0.3s ease-in-out; }
</style>

ä¸ºäº†å®ç°ä¸[æ¼”ç¤º](http://tobiasahlin.com/demo/animate-box-shadow/)ä¸­ä¸€æ ·çš„æ•ˆæœï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦çš„åªæ˜¯ï¼Œå½“ `.box` è¢«åˆ’è¿‡æ—¶ç¼©æ”¾å®ƒï¼Œå¹¶ä¸”æ¸å…¥é˜´å½±ã€‚

To create the same effect as in the [demo](http://tobiasahlin.com/demo/animate-box-shadow/), now all we need to do is to scale up the `.box` on hover, and fade in the pseudo-element and its shadow:


```
/* ç¼©æ”¾å¡ç‰‡ */
/* Scale up the box */
.box:hover {
  transform: scale(1.2, 1.2);
}

/* ä¼ªå…ƒç´ çš„é˜´å½±æ¸å…¥ */
/* Fade in the pseudo-element with the bigger shadow */
.box:hover::after {
  opacity: 1;
}
```

å¥½äº†ï¼å°±åˆ°è¿™äº†ï¼æˆ‘ä»¬èµ¶ç´§æ¥çœ‹çœ‹æ•ˆæœå§ã€‚

That's it! Hover the box to preview the effect:

<div id="box-2"></div>
<style type="text/css">
#box-2 { position: relative; display: block; margin: 0 auto; width: 100px; height: 100px; border-radius: 5px; background-color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.3s ease-in-out; }
#box-2::after { content: ''; position: absolute; z-index: -1; width: 100%; height: 100%; opacity: 0; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: opacity 0.3s ease-in-out; }
#box-2:hover { transform: scale(1.2, 1.2); }
#box-2:hover::after { opacity: 1; }
</style>

å¥½äº†ï¼Œä¸ºäº†æ€»ç»“ï¼Œè¿™é‡Œæ˜¯å®Œæ•´çš„ CSS ä»£ç ï¼Œè‡ªå¸¦~~ç‰¹æ•ˆ~~ï¼Œå¹¶ä¸”æœ‰ç€è‡ªå®šä¹‰çš„åŠ¨ç”»æ›²çº¿ã€‚

To summarize, here's all the CSS, with all vendor prefixes, and some custom easing for additional âœ¨ğŸ‘Œ:

```
.box {
  position: relative;
  display: inline-block;
  width: 100px;
  height: 100px;
  background-color: #fff;
  border-radius: 5px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  border-radius: 5px;
  -webkit-transition: all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
  transition: all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
}

.box::after {
  content: "";
  border-radius: 5px;
  position: absolute;
  z-index: -1;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  opacity: 0;
  -webkit-transition: all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
  transition: all 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
}

.box:hover {
  -webkit-transform: scale(1.25, 1.25);
  transform: scale(1.25, 1.25);
}

.box:hover::after {
    opacity: 1;
}
```

èƒ½ç¡®å®šï¼Œæˆ‘ä»¬èƒ½ç”¨ä¸€å¥ç®€çŸ­çš„è¯æ¥å®ç°çš„ `box-shadow` çš„åŠ¨ç”»ï¼Œæˆ‘ä»¬ç°åœ¨å´åªæ˜¯ä¸ºäº†é«˜æ•ˆï¼Œå´é€‰ç”¨äº†ä¸€ç§è®¸å¤šçš„ CSS ä»£ç ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Œå…„å¼Ÿï¼Ÿ

That's certainly a lot of CSS to achieve the same effect as simply animating `box-shadow`, just with improved performance. Why bother?

å³ä½¿ä½ çš„æ¡Œé¢ç³»ç»Ÿèƒ½å¤Ÿå¾ˆå¥½çš„å¤„ç† `box-shadow` çš„åŠ¨ç”»ï¼Œä½†æ˜¯ä½ çš„æ‰‹æœºå´å¯èƒ½ä¸è¡Œï¼Œç”šè‡³ä½ çš„ç”µè„‘åœ¨ä¸€äº›å¤æ‚çš„åŠ¨ç”»ä¸‹ä¹Ÿä¼šæ˜¾å¾—åƒåŠ›ã€‚

Even if your desktop likely handles animating `box-shadow` without any issues, your phone may not, and even your desktop may start to stutter when animating a more complex layout.

åšæŒåªå¯¹ `transform` å’Œ `opacity` ä½¿ç”¨ transition å’Œ animationï¼Œå¹¶ä¸”ä½ èƒ½ç¡®å®šå¯ä»¥è¾¾åˆ°æœ€å¥½çš„æ•ˆç‡ï¼Œæœ‰äº†å®ƒï¼Œé‚£ä¹ˆç”¨æˆ·ä½“éªŒå°±å¾ˆå¸…å•¦å•¦å•¦ã€‚

Keep transitions and animations to only transform and opacity, and you're certain to achieve the best possible performance, and with that, the best possible user experience.
